<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/code/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/code/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/code/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Redux,React," />





  <link rel="alternate" href="/code/atom.xml" title="罗峡的技术博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/code/favicon.ico?v=5.0.1" />






<meta name="description" content="也许你也感受到web世界的变化，web客户端从简单的展示性页面向着越来越复杂的web应用转化。而在前后端分离下的开发模式下，客户端数据逻辑变得纷繁复杂，难以维护。React设计理念之一为单向数据流，这从一方面方便了数据的管理。但是React本身只是view，并没有提供完备的数据管理方案。应由而生的其周边类库，诸如Imm">
<meta name="keywords" content="Redux,React">
<meta property="og:type" content="article">
<meta property="og:title" content="Redux管理复杂应用数据逻辑">
<meta property="og:url" content="http://luoxia.me/code/2016/10/04/Redux管理复杂应用数据逻辑/index.html">
<meta property="og:site_name" content="罗峡的技术博客">
<meta property="og:description" content="也许你也感受到web世界的变化，web客户端从简单的展示性页面向着越来越复杂的web应用转化。而在前后端分离下的开发模式下，客户端数据逻辑变得纷繁复杂，难以维护。React设计理念之一为单向数据流，这从一方面方便了数据的管理。但是React本身只是view，并没有提供完备的数据管理方案。应由而生的其周边类库，诸如ImmutableJS不变数据解决方案，flux作为state管理方案。而redux即">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xsi10.com1.z0.glb.clouddn.com/redux-flow.jpeg">
<meta property="og:updated_time" content="2017-11-16T13:10:06.485Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redux管理复杂应用数据逻辑">
<meta name="twitter:description" content="也许你也感受到web世界的变化，web客户端从简单的展示性页面向着越来越复杂的web应用转化。而在前后端分离下的开发模式下，客户端数据逻辑变得纷繁复杂，难以维护。React设计理念之一为单向数据流，这从一方面方便了数据的管理。但是React本身只是view，并没有提供完备的数据管理方案。应由而生的其周边类库，诸如ImmutableJS不变数据解决方案，flux作为state管理方案。而redux即">
<meta name="twitter:image" content="http://7xsi10.com1.z0.glb.clouddn.com/redux-flow.jpeg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://luoxia.me/code/2016/10/04/Redux管理复杂应用数据逻辑/"/>

  <title> Redux管理复杂应用数据逻辑 | 罗峡的技术博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?179492533449f84f24555d1cbf10462f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/code/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">罗峡的技术博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">爱技术，爱生活</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/code/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/code/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/code/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/code/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/code/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Redux管理复杂应用数据逻辑
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-04T19:57:32+08:00" content="2016-10-04">
              2016-10-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/code/categories/React/" itemprop="url" rel="index">
                    <span itemprop="name">React</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>也许你也感受到web世界的变化，web客户端从简单的展示性页面向着越来越复杂的web应用转化。而在前后端分离下的开发模式下，客户端数据逻辑变得纷繁复杂，难以维护。React设计理念之一为单向数据流，这从一方面方便了数据的管理。但是React本身只是view，并没有提供完备的数据管理方案。应由而生的其周边类库，诸如ImmutableJS不变数据解决方案，flux作为state管理方案。而redux即为类似于flux的数据解决方案。虽然文章分类于react，但是并不代表redux就与react有着必然的联系。其作为独立的库，适用于多个应由框架甚至是原生JavaScript。</p>
<p>类似于Redux的，有为Vue设计的Vuex。Redux/Vuex的数据管理方案，深深地透露出函数式编程(FP)的思想。对于习惯了面向对象(OO)思想的我们来说，函数式编程也是一大挑战。所以本人也打算对函数式编程的一些主要概率进行总结，作为单独的一篇文章。<br><img src="http://7xsi10.com1.z0.glb.clouddn.com/redux-flow.jpeg" alt="原理图"></p>
<p><strong>国庆节还在写代码的，一定是单身狗</strong></p>
<a id="more"></a>
<h3 id="整体分析"><a href="#整体分析" class="headerlink" title="整体分析:"></a>整体分析:</h3><ol>
<li>应用分为两个大部分，一个是UI,一个是数据，    UI根据数据来渲染，不同的数据渲染出不同的UI，即是UI的各个状态state;</li>
</ol>
<ol>
<li>State如何改变：用户产生操作，触发事件，组件层次设计为两类，一类为展示性组件(Dumb/Presentational Components)，不处理数据逻辑相关，一类为容器组件（Smart/Container Components)展示性组件根据用户操作触发事件，向容器组件派发，容器组件发生dispatch。</li>
</ol>
<ol>
<li>传入dispatch的为Action生成函数，Action为一个含有type属性的js对象，但是通过Middleware即中间件，可以让action生成函数不一定直接返回对象，如redux-thunk中间件可以让其返回函数，根据这个，可以处理异步的数据流。</li>
</ol>
<ol>
<li>reducer指定如何更新Sate,其为纯函数，并且不直接修改原始state，而是保持原有state不变，返回全新的state</li>
</ol>
<ol>
<li>state更新，触发渲染，UI更新。</li>
</ol>
<h3 id="三大原则"><a href="#三大原则" class="headerlink" title="三大原则:"></a>三大原则:</h3><h4 id="单一数据源"><a href="#单一数据源" class="headerlink" title="单一数据源"></a>单一数据源</h4><p>即整个应用只有一个store来管理state，与flux明显不同，这样使得管理更加方便，但也需要我们自己去分解store,这个可以通过分解reducer来实现</p>
<h4 id="State的改变只能通过分发action"><a href="#State的改变只能通过分发action" class="headerlink" title="State的改变只能通过分发action"></a>State的改变只能通过分发action</h4><p>即State是只读的，应用中不能直接修改state,只能产生dispatch,靠action生成函数生成action,然后reducer更新state</p>
<h4 id="通过纯函数修改State"><a href="#通过纯函数修改State" class="headerlink" title="通过纯函数修改State"></a>通过纯函数修改State</h4><p>纯函数的问题，也是来自于函数式编程思想，我们在中学时学的函数就是纯函数，对于同一个输入，必然有相同的输出。这就保证了数据的可控性。什么情况下导致函数不纯呢？</p>
<p>如：</p>
<p>. 修改传入参数；</p>
<p>. 执行有副作用的操作，如 API 请求和路由跳转；</p>
<p>. 调用非纯函数，如 Date.now() 或 Math.random()。</p>
<p>state每次更新，原本的state保持不变，这使得利用redux实现时间旅行，撤销重做更加容易。如更改一个state对象的某个属性:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,&#123;</span><br><span class="line">           [action.reddit]: posts(state,action)</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>
<p>或者使用ES7的对象rest语法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;...state,[action.reddit]: posts(state,action)&#125;</span><br></pre></td></tr></table></figure>
<p>或者可以使用immutable.js库，生成不变的数据类型。</p>
<h3 id="直接上实例，逐步分析"><a href="#直接上实例，逐步分析" class="headerlink" title="直接上实例，逐步分析"></a>直接上实例，逐步分析</h3><p>以官方的Reddit API实例来分析，这个例子涉及到主要的知识点，包括一些高级的中间件，异步数据流，以及组件层次的设计等。</p>
<h4 id="index-js入口文件："><a href="#index-js入口文件：" class="headerlink" title="index.js入口文件："></a>index.js入口文件：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createStore,applyMiddleware,compose&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Provider&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers/index'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./containers/App'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middleWare = [thunk,createLogger()];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">    reducer,compose(</span><br><span class="line">        applyMiddleware(...middleWare),</span><br><span class="line">        <span class="built_in">window</span>.devToolsExtension ? <span class="built_in">window</span>.devToolsExtension() : <span class="function"><span class="params">f</span> =&gt;</span> f</span><br><span class="line">    )   </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">        &lt;App/&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById('root')</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<p>首先上面的store常量即为整个应用的唯一store,通过createStore()方法生成，其参数有reducer,以及使用的默认state,使用的中间件，applyMiddleWare使用一系列的中间件，它的作用是对action creater返回的数据进行处理，然后交给reducer。</p>
<p>react-redux使得react更好的和redux结合，提供Provider组件包裹我们的组件，这样我们的组件就能直接访问到dispatch方法和state.我们可以利用后面讲到的connect方法将组件和redux连接。</p>
<h4 id="action"><a href="#action" class="headerlink" title="action"></a>action</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REQUEST_POSTS = <span class="string">'REQUEST_POSTS'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RECEIVE_POSTS = <span class="string">'RECEIVE_POSTS'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SELECT_REDDIT = <span class="string">'SELECT_REDDIT'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INVALIDATE_REDDIT = <span class="string">'INVALIDATE_REDDIT'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectReddit = <span class="function"><span class="params">reddit</span> =&gt;</span> (&#123;</span><br><span class="line">    type: SELECT_REDDIT,</span><br><span class="line">    reddit</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> requestPosts = <span class="function"><span class="params">reddit</span> =&gt;</span> (&#123;</span><br><span class="line">    type: REQUEST_POSTS,</span><br><span class="line">    reddit</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> receivePosts = <span class="function">(<span class="params">reddit,json</span>)=&gt;</span>(&#123;</span><br><span class="line">    type: RECEIVE_POSTS,</span><br><span class="line">    reddit,</span><br><span class="line">    posts: json.data.children.map(<span class="function"><span class="params">child</span>=&gt;</span>child.data),</span><br><span class="line">    receivedAt: <span class="built_in">Date</span>.now()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> invalidateReddit = <span class="function"><span class="params">reddit</span> =&gt;</span> (&#123;</span><br><span class="line">    type: INVALIDATE_REDDIT,</span><br><span class="line">    reddit</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fetchPosts = <span class="function"><span class="params">reddit</span> =&gt;</span> dispatch =&gt; &#123;</span><br><span class="line">    dispatch(requestPosts(reddit));</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">`https://www.reddit.com/r/<span class="subst">$&#123;reddit&#125;</span>.json`</span>)</span><br><span class="line">        .then(<span class="function"><span class="params">response</span>=&gt;</span>response.json())</span><br><span class="line">        .then(<span class="function"><span class="params">json</span>=&gt;</span>dispatch(receivePosts(reddit,json)));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> shouldFetchPosts= <span class="function">(<span class="params">state,reddit</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> posts = state.postsByReddit[reddit];</span><br><span class="line">    <span class="keyword">if</span>(!posts) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(posts.isFetching) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> posts.didInvalidate;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchPostsIfNeeded = <span class="function"><span class="params">reddit</span> =&gt;</span> (dispatch,getState) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(shouldFetchPosts(getState(),reddit))&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(fetchPosts(reddit));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到上述的fetchPosts函数，返回的并不是一个action对象，而是返回了一个函数，这个默认redux是没法处理的，这就需要使用中间件处理了，redux-thunk中间件用于处理返回函数的函数，thunk函数在我之前的一篇’异步编程解决方案’也提到过，即接受回调函数的函数。这里返回的这个函数，其又返回一个promise对象，即通过fetch API异步发起请求，最终返回Promise对象。这里传入的dispatch也是中间件封装dispatch()方法的作用结果。</p>
<h4 id="reducer"><a href="#reducer" class="headerlink" title="reducer"></a>reducer</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;combineReducers&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    REQUEST_POSTS,RECEIVE_POSTS,</span><br><span class="line">    SELECT_REDDIT,INVALIDATE_REDDIT</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../actions/index.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> selectReddit = <span class="function">(<span class="params">state = <span class="string">'reactjs'</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(action.type)&#123;</span><br><span class="line">        <span class="keyword">case</span> SELECT_REDDIT:</span><br><span class="line">            <span class="keyword">return</span> action.reddit;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> posts = (state = &#123;</span><br><span class="line">    isFetching:<span class="literal">false</span>,</span><br><span class="line">    didInvalidate:<span class="literal">false</span>,</span><br><span class="line">    items:[]</span><br><span class="line">&#125;,action) =&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span>(action.type)&#123;</span><br><span class="line">        <span class="keyword">case</span> INVALIDATE_REDDIT:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,&#123;<span class="attr">didInvalidate</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">        <span class="keyword">case</span> REQUEST_POSTS:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,&#123;<span class="attr">isFetching</span>:<span class="literal">true</span>,<span class="attr">didInvalidate</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">        <span class="keyword">case</span> RECEIVE_POSTS:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,&#123;<span class="attr">isFetching</span>:<span class="literal">false</span>,<span class="attr">didInvalidate</span>:<span class="literal">false</span>,<span class="attr">items</span>:action.posts,<span class="attr">lastUpdated</span>:action.receivedAt&#125;);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postsByReddit = <span class="function">(<span class="params">state=&#123; &#125;,action</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(action.type)&#123;</span><br><span class="line">        <span class="keyword">case</span> INVALIDATE_REDDIT:</span><br><span class="line">        <span class="keyword">case</span> REQUEST_POSTS:</span><br><span class="line">        <span class="keyword">case</span> RECEIVE_POSTS:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,&#123;</span><br><span class="line">                [action.reddit]: posts(state,action)</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123;</span><br><span class="line">    postsByReddit,</span><br><span class="line">    selectReddit</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> rootReducer;</span><br></pre></td></tr></table></figure>
<p>可见，这种写法用到了一种技巧，即对大的state进行了分解，一部分为postsByReddit，一部分为selectReddit,避免了代码的冗长，最后只需通过combineReducers()方法将分解的reducer结合即可。</p>
<h4 id="设计组件层次"><a href="#设计组件层次" class="headerlink" title="设计组件层次"></a>设计组件层次</h4><p>按照之前所述的组件层次设计哲学思想，将组件分为container组件和展示组件，只让container来产生dispatch,而这个container哪些组件才有资格担任呢？通常是App即最外层父组件，然后当我们在使用react-router的时候，每个route都可以作为单独的container与redux相连接。</p>
<p>来看看这个例子的App.js:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> React,&#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;selectReddit,invalidateReddit,fetchPostsIfNeeded&#125; <span class="keyword">from</span> <span class="string">'../actions/index'</span>;</span><br><span class="line"><span class="keyword">import</span> Picker <span class="keyword">from</span> <span class="string">'../components/Picker'</span>;</span><br><span class="line"><span class="keyword">import</span> Posts <span class="keyword">from</span> <span class="string">'../components/Posts'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;dispatch,selectReddit&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        dispatch(fetchPostsIfNeeded(selectReddit));</span><br><span class="line">    &#125;</span><br><span class="line">    handleChange(nextReddit)&#123;</span><br><span class="line">        <span class="keyword">this</span>.props.dispatch(selectReddit(nextReddit));</span><br><span class="line">    &#125;</span><br><span class="line">    handleRefreshClick(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123;dispatch,selectReddit&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        dispatch(invalidateReddit(selectReddit));</span><br><span class="line">        dispatch(fetchPostsIfNeeded(selectReddit));</span><br><span class="line">    &#125;</span><br><span class="line">    componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextProps.selectReddit !== <span class="keyword">this</span>.props.selectReddit) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; dispatch, selectReddit &#125; = nextProps;</span><br><span class="line">            dispatch(fetchPostsIfNeeded(selectReddit));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;posts,selectReddit,lastUpdated,isFetching&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">const</span> isEmpty = posts.length === <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;Picker value=&#123;selectReddit&#125;</span><br><span class="line">                        onChange=&#123;<span class="keyword">this</span>.handleChange.bind(<span class="keyword">this</span>)&#125;</span><br><span class="line">                        options=&#123;[<span class="string">'reactjs'</span>,<span class="string">'frontend'</span>]&#125;/&gt;</span><br><span class="line">                &lt;p&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        lastUpdated &amp;&amp; </span><br><span class="line">                        &lt;span&gt;</span><br><span class="line">                            最后更新时间:&#123;<span class="keyword">new</span> <span class="built_in">Date</span>(lastUpdated).toLocaleTimeString()&#125;</span><br><span class="line">                        &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">                    &#125;</span></span><br><span class="line"><span class="regexp">                    &#123;</span></span><br><span class="line"><span class="regexp">                        !isFetching &amp;&amp; </span></span><br><span class="line"><span class="regexp">                        &lt;a href="javascript:;" onClick=&#123;this.handleRefreshClick.bind(this)&#125;&gt;刷新</span></span><br><span class="line"><span class="regexp">                        &lt;/</span>a&gt;</span><br><span class="line">                    &#125;</span><br><span class="line">                &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                    isEmpty? (isFetching?&lt;h3&gt;正在加载当中...&lt;/</span>h3&gt;:&lt;h3&gt;没有相关文章&lt;/h3&gt;)</span><br><span class="line">                            :&lt;div style=&#123;&#123;backgroundColor:isFetching?0.5:1&#125;&#125;&gt;</span><br><span class="line">                                &lt;Posts posts=&#123;posts&#125;/&gt;&lt;/div&gt;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;selectReddit,postsByReddit&#125; = state;</span><br><span class="line">    <span class="keyword">const</span> &#123;isFetching,lastUpdated,<span class="attr">items</span>:posts=[]&#125; = postsByReddit[selectReddit] ||</span><br><span class="line">            &#123;</span><br><span class="line">                isFetching:<span class="literal">true</span>,</span><br><span class="line">                items: []</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        selectReddit,</span><br><span class="line">        isFetching,</span><br><span class="line">        lastUpdated,</span><br><span class="line">        posts</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps)(App);</span><br></pre></td></tr></table></figure>
<p>可见我们将App与Redux进行了连接，通过connect方法,我们知道，当组件与redux连接时，我们就能获得dispatch和store,而mapStateToProps正是根据获得的state生成了App需要用到的props，这样我们的state就与组件联系在一起了。</p>
<h3 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h3><p>可见，redux的数据管理方案相对于之前的组件单独管理自己的state确实是清晰了不少，但是要求我们的学习成本也更高了，我们需要有一定的函数式编程思想，我们还得自己去设计组件的层次。这种数据管理方式，对于复杂应用确实比较适合，但是当我们的应用足够简单的时候，使用redux是否是画蛇添足，反而使得问题复杂化了。具体的应用场景还得在实践当中去感悟。。。</p>
<p>因为最近项目的需要，其复杂程度也足够需要使用类似于redux的数据管理模式，还有一些问题没有很好的解决，如react父路由与子路由的数据传输。之前的vue可以直接通过router-view那种类似于父子组件的props传递方式进行数据传递，但react貌似没这种处理方式，所以就在想除了各个router都与redux相连的处理方式，还有什么办法，等着解决。</p>
<p><strong>国庆节假期即将结束，紧张又充实的生活又将开启</strong></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/code/images/wechat.jpg" alt="罗峡的博客 wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎扫描上面的微信公众号二维码，关注我的个人公众号：全栈前端</div>
</div>


      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/code/images/wechat_pay.png" alt="罗峡的博客 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/code/images/ali_pay.jpg" alt="罗峡的博客 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/code/tags/Redux/" rel="tag">#Redux</a>
          
            <a href="/code/tags/React/" rel="tag">#React</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/code/2016/09/24/session身份验证/" rel="next" title="session身份验证">
                <i class="fa fa-chevron-left"></i> session身份验证
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/code/2016/10/16/数据推送业务解决方案/" rel="prev" title="数据推送业务解决方案">
                数据推送业务解决方案 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/code/images/head.jpg"
               alt="罗峡的博客" />
          <p class="site-author-name" itemprop="name">罗峡的博客</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/code/archives">
              <span class="site-state-item-count">43</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/code/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/code/tags">
                <span class="site-state-item-count">85</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/code/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/laoqiren" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://luoxia.me/life" title="生活随笔" target="_blank">生活随笔</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#整体分析"><span class="nav-number">1.</span> <span class="nav-text">整体分析:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三大原则"><span class="nav-number">2.</span> <span class="nav-text">三大原则:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单一数据源"><span class="nav-number">2.1.</span> <span class="nav-text">单一数据源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#State的改变只能通过分发action"><span class="nav-number">2.2.</span> <span class="nav-text">State的改变只能通过分发action</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过纯函数修改State"><span class="nav-number">2.3.</span> <span class="nav-text">通过纯函数修改State</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#直接上实例，逐步分析"><span class="nav-number">3.</span> <span class="nav-text">直接上实例，逐步分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#index-js入口文件："><span class="nav-number">3.1.</span> <span class="nav-text">index.js入口文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#action"><span class="nav-number">3.2.</span> <span class="nav-text">action</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reducer"><span class="nav-number">3.3.</span> <span class="nav-text">reducer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设计组件层次"><span class="nav-number">3.4.</span> <span class="nav-text">设计组件层次</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结束语"><span class="nav-number">4.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">罗峡的博客</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/code/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/code/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/code/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/code/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/code/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/code/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/code/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/code/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/code/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/code/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/code/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/code/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
